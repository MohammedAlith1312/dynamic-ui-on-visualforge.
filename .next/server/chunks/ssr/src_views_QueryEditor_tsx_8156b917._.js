module.exports=[2539,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(50944),e=a.i(74167),f=a.i(99570),g=a.i(66718),h=a.i(70430),i=a.i(29246),j=a.i(63658),k=a.i(210),l=a.i(14548),m=a.i(77430),n=a.i(80701);function o({queryId:a,queryType:d}){let{toast:f}=(0,m.useToast)(),[i,k]=(0,c.useState)([]),[l,o]=(0,c.useState)({primary_entity_id:"",group_by:[],sort_entity_id:null,sort_field:null,sort_order:"asc",limit_rows:50,display_style:"table",show_row_numbers:!1});(0,c.useEffect)(()=>{p(),q()},[a]);let p=async()=>{let{data:a}=await e.supabase.from("entities").select("id, display_name").order("display_name");k(a||[])},q=async()=>{let{data:b}=await e.supabase.from("query_settings").select("*").eq("query_id",a).maybeSingle();b&&o(b)},r=async b=>{let c={...l,...b};o(c);try{let{error:b}=await e.supabase.from("query_settings").upsert({query_id:a,...c});if(b)throw b}catch(a){f({title:"Error updating settings",description:a.message,variant:"destructive"})}};return(0,b.jsxs)("div",{className:"space-y-6 p-6 border rounded-lg",children:[(0,b.jsx)("h3",{className:"text-lg font-semibold",children:"Query Settings"}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(h.Label,{children:"Primary Entity"}),(0,b.jsxs)(n.Select,{value:l.primary_entity_id,onValueChange:a=>r({primary_entity_id:a}),children:[(0,b.jsx)(n.SelectTrigger,{children:(0,b.jsx)(n.SelectValue,{placeholder:"Select entity"})}),(0,b.jsx)(n.SelectContent,{children:i.map(a=>(0,b.jsx)(n.SelectItem,{value:a.id,children:a.display_name},a.id))})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(h.Label,{children:"Sort Field"}),(0,b.jsx)(g.Input,{placeholder:"Field name",value:l.sort_field||"",onChange:a=>r({sort_field:a.target.value})})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(h.Label,{children:"Sort Order"}),(0,b.jsxs)(n.Select,{value:l.sort_order||"asc",onValueChange:a=>r({sort_order:a}),children:[(0,b.jsx)(n.SelectTrigger,{children:(0,b.jsx)(n.SelectValue,{})}),(0,b.jsxs)(n.SelectContent,{children:[(0,b.jsx)(n.SelectItem,{value:"asc",children:"Ascending"}),(0,b.jsx)(n.SelectItem,{value:"desc",children:"Descending"})]})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(h.Label,{children:"Limit Rows"}),(0,b.jsx)(g.Input,{type:"number",min:"1",max:"500",value:l.limit_rows,onChange:a=>r({limit_rows:parseInt(a.target.value)||50})})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(h.Label,{children:"Display Style"}),(0,b.jsxs)(n.Select,{value:l.display_style,onValueChange:a=>r({display_style:a}),children:[(0,b.jsx)(n.SelectTrigger,{children:(0,b.jsx)(n.SelectValue,{})}),(0,b.jsxs)(n.SelectContent,{children:[(0,b.jsx)(n.SelectItem,{value:"table",children:"Table"}),(0,b.jsx)(n.SelectItem,{value:"grid",children:"Grid"}),(0,b.jsx)(n.SelectItem,{value:"list",children:"List"})]})]})]}),(0,b.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,b.jsx)(j.Switch,{checked:l.show_row_numbers,onCheckedChange:a=>r({show_row_numbers:a})}),(0,b.jsx)(h.Label,{children:"Show Row Numbers"})]})]})}var p=a.i(15618),q=a.i(81560);function r({queryId:a,queryType:d,primaryEntityId:g}){let{toast:i}=(0,m.useToast)(),[j,k]=(0,c.useState)([]),[l,o]=(0,c.useState)([]),[r,s]=(0,c.useState)(""),[t,u]=(0,c.useState)(""),[v,w]=(0,c.useState)(""),[x,y]=(0,c.useState)([]);(0,c.useEffect)(()=>{z(),A()},[a]);let z=async()=>{let{data:a}=await e.supabase.from("entities").select("id, display_name").order("display_name");k(a||[])},A=async()=>{let{data:b}=await e.supabase.from("query_fields").select("*").eq("query_id",a).order("position");o(b||[])},B=async a=>{if(!a)return void y([]);let{data:b}=await e.supabase.from("entity_fields").select("id, name, display_name, field_type").eq("entity_id",a).order("position");y(b||[])},C=async()=>{if(r&&t)try{let{error:b}=await e.supabase.from("query_fields").insert({query_id:a,entity_id:r,field_name:t,aggregation:"aggregate"===d&&v||null,position:l.length});if(b)throw b;s(""),u(""),w(""),A(),i({title:"Field added",description:"The field has been added to the query."})}catch(a){i({title:"Error adding field",description:a.message,variant:"destructive"})}},D=async a=>{try{let{error:b}=await e.supabase.from("query_fields").delete().eq("id",a);if(b)throw b;A(),i({title:"Field removed",description:"The field has been removed from the query."})}catch(a){i({title:"Error removing field",description:a.message,variant:"destructive"})}};return(0,b.jsxs)("div",{className:"space-y-4 p-6 border rounded-lg",children:[(0,b.jsx)("h3",{className:"text-lg font-semibold",children:"Query Fields"}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(h.Label,{children:"Entity"}),(0,b.jsxs)(n.Select,{value:r,onValueChange:a=>{s(a),u(""),y([]),B(a)},children:[(0,b.jsx)(n.SelectTrigger,{children:(0,b.jsx)(n.SelectValue,{placeholder:"Select entity"})}),(0,b.jsx)(n.SelectContent,{children:j.map(a=>(0,b.jsx)(n.SelectItem,{value:a.id,children:a.display_name},a.id))})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(h.Label,{children:"Field"}),(0,b.jsxs)(n.Select,{value:t,onValueChange:u,disabled:!r||0===x.length,children:[(0,b.jsx)(n.SelectTrigger,{children:(0,b.jsx)(n.SelectValue,{placeholder:r?"Select field":"Select entity first"})}),(0,b.jsx)(n.SelectContent,{children:x.map(a=>(0,b.jsxs)(n.SelectItem,{value:a.name,children:[a.display_name," (",a.field_type,")"]},a.id))})]})]}),"aggregate"===d&&(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(h.Label,{children:"Aggregation"}),(0,b.jsxs)(n.Select,{value:v,onValueChange:w,children:[(0,b.jsx)(n.SelectTrigger,{children:(0,b.jsx)(n.SelectValue,{placeholder:"None"})}),(0,b.jsxs)(n.SelectContent,{children:[(0,b.jsx)(n.SelectItem,{value:"",children:"None"}),(0,b.jsx)(n.SelectItem,{value:"count",children:"COUNT"}),(0,b.jsx)(n.SelectItem,{value:"sum",children:"SUM"}),(0,b.jsx)(n.SelectItem,{value:"avg",children:"AVG"}),(0,b.jsx)(n.SelectItem,{value:"min",children:"MIN"}),(0,b.jsx)(n.SelectItem,{value:"max",children:"MAX"})]})]})]})]}),(0,b.jsxs)(f.Button,{onClick:C,size:"sm",children:[(0,b.jsx)(p.Plus,{className:"h-4 w-4 mr-2"}),"Add Field"]}),(0,b.jsx)("div",{className:"space-y-2 mt-4",children:l.map(a=>{let c=j.find(b=>b.id===a.entity_id);return(0,b.jsxs)("div",{className:"flex items-center justify-between p-2 border rounded",children:[(0,b.jsxs)("span",{className:"text-sm",children:[c?.display_name,": ",a.field_name,a.aggregation&&` (${a.aggregation.toUpperCase()})`]}),(0,b.jsx)(f.Button,{variant:"ghost",size:"sm",onClick:()=>D(a.id),children:(0,b.jsx)(q.Trash2,{className:"h-4 w-4"})})]},a.id)})})]})}let s=(0,a.i(70106).default)("FolderPlus",[["path",{d:"M12 10v6",key:"1bos4e"}],["path",{d:"M9 13h6",key:"1uhe8q"}],["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]]);var t=a.i(50522),u=a.i(5784);let v=[{value:"inner",label:"Inner Join"},{value:"left",label:"Left Join"},{value:"right",label:"Right Join"}];function w({node:a,level:d,entities:g,onRefresh:h}){let[i,j]=(0,c.useState)([]),[k,l]=(0,c.useState)(!0),[o,r]=(0,c.useState)([]),[x,y]=(0,c.useState)([]),[z,A]=(0,c.useState)([]),{toast:B}=(0,m.useToast)();(0,c.useEffect)(()=>{a.is_group?C():a.target_entity_id&&(D(a.target_entity_id),E())},[a.id,a.is_group,a.target_entity_id]);let C=async()=>{let{data:b}=await e.supabase.from("query_joins").select("*").eq("parent_join_id",a.id).order("position");j(b||[])},D=async a=>{let{data:b}=await e.supabase.from("entity_fields").select("id, name, display_name, entity_id").eq("entity_id",a).order("display_name");y(b||[])},E=async()=>{let{data:b}=await e.supabase.from("query_join_conditions").select("*").eq("join_id",a.id).order("position");A(b||[])},F=async b=>{try{let{error:c}=await e.supabase.from("query_joins").update(b).eq("id",a.id);if(c)throw c;b.target_entity_id&&D(b.target_entity_id),h(),a.is_group&&C()}catch(a){B({title:"Error updating join",description:a.message,variant:"destructive"})}},G=async()=>{try{let{error:b}=await e.supabase.from("query_joins").delete().eq("id",a.id);if(b)throw b;h(),B({title:"Join deleted"})}catch(a){B({title:"Error deleting join",description:a.message,variant:"destructive"})}},H=async()=>{if(!g.length)return void B({title:"No entities available",description:"Please create at least one entity first.",variant:"destructive"});try{let b=i.length,{error:c}=await e.supabase.from("query_joins").insert({query_id:a.query_id,parent_join_id:a.id,is_group:!1,target_entity_id:g[0].id,join_type:"inner",primary_field:"",target_field:"",position:b});if(c)throw c;C(),B({title:"Join added"})}catch(a){B({title:"Error adding join",description:a.message,variant:"destructive"})}},I=async()=>{try{let b=i.length,{error:c}=await e.supabase.from("query_joins").insert({query_id:a.query_id,parent_join_id:a.id,is_group:!0,position:b});if(c)throw c;C(),B({title:"Join group added"})}catch(a){B({title:"Error adding join group",description:a.message,variant:"destructive"})}},J=async()=>{if(!x.length)return void B({title:"No fields available",description:"Select an entity first.",variant:"destructive"});try{let b=z.length,{error:c}=await e.supabase.from("query_join_conditions").insert({join_id:a.id,primary_field:x[0].name,target_field:x[0].name,logic:"and",position:b});if(c)throw c;E(),B({title:"Join condition added"})}catch(a){B({title:"Error adding join condition",description:a.message,variant:"destructive"})}},K=async(a,b)=>{try{let{error:c}=await e.supabase.from("query_join_conditions").update(b).eq("id",a);if(c)throw c;E()}catch(a){B({title:"Error updating join condition",description:a.message,variant:"destructive"})}},L=async a=>{try{let{error:b}=await e.supabase.from("query_join_conditions").delete().eq("id",a);if(b)throw b;E(),B({title:"Join condition deleted"})}catch(a){B({title:"Error deleting join condition",description:a.message,variant:"destructive"})}};return a.is_group?(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsxs)("div",{className:"flex items-center gap-1.5 p-2 rounded-md bg-muted/30 hover:bg-muted/50 transition-colors",children:[(0,b.jsx)(f.Button,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0",onClick:()=>l(!k),children:k?(0,b.jsx)(u.ChevronDown,{className:"h-3 w-3"}):(0,b.jsx)(t.ChevronRight,{className:"h-3 w-3"})}),(0,b.jsx)(s,{className:"h-3.5 w-3.5 text-muted-foreground"}),(0,b.jsx)("span",{className:"text-xs font-medium",children:"Join Group"}),(0,b.jsx)("div",{className:"flex-1"}),(0,b.jsxs)(f.Button,{onClick:H,size:"sm",variant:"ghost",className:"h-6 text-xs px-1.5",children:[(0,b.jsx)(p.Plus,{className:"h-3 w-3 mr-1"}),"Join"]}),(0,b.jsxs)(f.Button,{onClick:I,size:"sm",variant:"ghost",className:"h-6 text-xs px-1.5",children:[(0,b.jsx)(s,{className:"h-3 w-3 mr-1"}),"Group"]}),(0,b.jsx)(f.Button,{variant:"ghost",size:"sm",onClick:G,className:"h-6 w-6 p-0",children:(0,b.jsx)(q.Trash2,{className:"h-3 w-3 text-destructive"})})]}),k&&(0,b.jsx)("div",{className:"ml-3 border-l-2 border-border/50 pl-2 space-y-1",children:0===i.length?(0,b.jsx)("div",{className:"bg-muted/20 p-2 rounded text-center",children:(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:"Empty group"})}):i.map(a=>(0,b.jsx)(w,{node:a,level:d+1,entities:g,onRefresh:C},a.id))})]}):(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsxs)("div",{className:"flex items-center gap-1.5 p-2 rounded-md bg-card border hover:border-primary/30 transition-colors group",children:[(0,b.jsxs)(n.Select,{value:a.join_type||"inner",onValueChange:a=>F({join_type:a}),children:[(0,b.jsx)(n.SelectTrigger,{className:"h-7 w-[90px] text-xs",children:(0,b.jsx)(n.SelectValue,{})}),(0,b.jsx)(n.SelectContent,{className:"bg-popover z-50",children:v.map(a=>(0,b.jsx)(n.SelectItem,{value:a.value,className:"text-xs",children:a.label},a.value))})]}),(0,b.jsxs)(n.Select,{value:a.target_entity_id||"",onValueChange:a=>F({target_entity_id:a}),children:[(0,b.jsx)(n.SelectTrigger,{className:"h-7 w-[130px] text-xs",children:(0,b.jsx)(n.SelectValue,{placeholder:"Entity"})}),(0,b.jsx)(n.SelectContent,{className:"bg-popover z-50",children:g.map(a=>(0,b.jsx)(n.SelectItem,{value:a.id,className:"text-xs",children:a.display_name},a.id))})]}),(0,b.jsx)("span",{className:"text-xs text-muted-foreground",children:"ON"}),z.length>0&&(0,b.jsxs)("span",{className:"text-xs text-muted-foreground",children:["(",z.length," condition",1!==z.length?"s":"",")"]}),(0,b.jsx)("div",{className:"flex-1"}),(0,b.jsxs)(f.Button,{onClick:J,size:"sm",variant:"ghost",className:"h-6 text-xs px-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[(0,b.jsx)(p.Plus,{className:"h-3 w-3 mr-1"}),"Add Condition"]}),(0,b.jsx)(f.Button,{variant:"ghost",size:"sm",onClick:G,className:"h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity",children:(0,b.jsx)(q.Trash2,{className:"h-3 w-3 text-destructive"})})]}),z.length>0&&(0,b.jsx)("div",{className:"ml-3 border-l-2 border-border/30 pl-2 space-y-1",children:z.map((a,c)=>(0,b.jsxs)("div",{className:"flex items-center gap-1.5 p-1.5 rounded-md bg-muted/20 hover:bg-muted/40 transition-colors group/condition",children:[0===c?(0,b.jsx)("div",{className:"h-6 w-14 flex items-center justify-center",children:(0,b.jsx)("span",{className:"text-[10px] text-muted-foreground font-medium",children:"AND"})}):(0,b.jsxs)(n.Select,{value:a.logic,onValueChange:b=>K(a.id,{logic:b}),children:[(0,b.jsx)(n.SelectTrigger,{className:"h-6 w-14 text-xs",children:(0,b.jsx)(n.SelectValue,{})}),(0,b.jsxs)(n.SelectContent,{className:"bg-popover z-50",children:[(0,b.jsx)(n.SelectItem,{value:"and",className:"text-xs",children:"AND"}),(0,b.jsx)(n.SelectItem,{value:"or",className:"text-xs",children:"OR"})]})]}),(0,b.jsxs)(n.Select,{value:a.primary_field,onValueChange:b=>K(a.id,{primary_field:b}),children:[(0,b.jsx)(n.SelectTrigger,{className:"h-6 w-[110px] text-xs",children:(0,b.jsx)(n.SelectValue,{placeholder:"Primary field"})}),(0,b.jsx)(n.SelectContent,{className:"bg-popover z-50",children:x.map(a=>(0,b.jsx)(n.SelectItem,{value:a.name,className:"text-xs",children:a.display_name},a.id))})]}),(0,b.jsx)("span",{className:"text-xs text-muted-foreground",children:"="}),(0,b.jsxs)(n.Select,{value:a.target_field,onValueChange:b=>K(a.id,{target_field:b}),children:[(0,b.jsx)(n.SelectTrigger,{className:"h-6 w-[110px] text-xs",children:(0,b.jsx)(n.SelectValue,{placeholder:"Target field"})}),(0,b.jsx)(n.SelectContent,{className:"bg-popover z-50",children:x.map(a=>(0,b.jsx)(n.SelectItem,{value:a.name,className:"text-xs",children:a.display_name},a.id))})]}),(0,b.jsx)(f.Button,{variant:"ghost",size:"sm",onClick:()=>L(a.id),className:"h-5 w-5 p-0 opacity-0 group-hover/condition:opacity-100 transition-opacity",children:(0,b.jsx)(q.Trash2,{className:"h-2.5 w-2.5 text-destructive"})})]},a.id))})]})}let x=function({queryId:a}){let[d,g]=(0,c.useState)([]),[h,i]=(0,c.useState)([]),{toast:j}=(0,m.useToast)();(0,c.useEffect)(()=>{k(),l()},[a]);let k=async()=>{let{data:a}=await e.supabase.from("entities").select("id, display_name").order("display_name");g(a||[])},l=async()=>{let{data:b}=await e.supabase.from("query_joins").select("*").eq("query_id",a).is("parent_join_id",null).order("position");i(b||[])},n=async(b=null)=>{if(console.log("addJoin called",{parentId:b,entitiesLength:d.length}),!d.length)return void j({title:"No entities available",description:"Please create at least one entity first.",variant:"destructive"});try{let c=h.length,f={query_id:a,parent_join_id:b,is_group:!1,target_entity_id:d[0].id,join_type:"inner",primary_field:"",target_field:"",position:c};console.log("Inserting join:",f);let{data:g,error:i}=await e.supabase.from("query_joins").insert(f);if(console.log("Insert result:",{data:g,error:i}),i)throw i;l(),j({title:"Join added"})}catch(a){console.error("Error adding join:",a),j({title:"Error adding join",description:a.message,variant:"destructive"})}},o=async(b=null)=>{console.log("addJoinGroup called",{parentId:b});try{let c=h.length,d={query_id:a,parent_join_id:b,is_group:!0,position:c};console.log("Inserting join group:",d);let{data:f,error:g}=await e.supabase.from("query_joins").insert(d);if(console.log("Insert group result:",{data:f,error:g}),g)throw g;l(),j({title:"Join group added"})}catch(a){console.error("Error adding join group:",a),j({title:"Error adding join group",description:a.message,variant:"destructive"})}};return(0,b.jsxs)("div",{className:"space-y-3",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsx)("h3",{className:"text-sm font-semibold",children:"Joins"}),(0,b.jsxs)("div",{className:"flex gap-1.5",children:[(0,b.jsxs)(f.Button,{onClick:()=>n(),size:"sm",variant:"outline",className:"h-7 text-xs",children:[(0,b.jsx)(p.Plus,{className:"h-3 w-3 mr-1"}),"Join"]}),(0,b.jsxs)(f.Button,{onClick:()=>o(),size:"sm",variant:"outline",className:"h-7 text-xs",children:[(0,b.jsx)(s,{className:"h-3 w-3 mr-1"}),"Group"]})]})]}),0===h.length?(0,b.jsx)("div",{className:"bg-muted/30 p-4 rounded-md text-center",children:(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:'No joins configured. Click "Join" to add one.'})}):(0,b.jsx)("div",{className:"space-y-1 border-l-2 border-border/50 pl-2",children:h.map(a=>(0,b.jsx)(w,{node:a,level:0,entities:d,onRefresh:l},a.id))})]})},y=[{value:"equals",label:"Equals"},{value:"not_equals",label:"Not Equals"},{value:"gt",label:"Greater Than"},{value:"lt",label:"Less Than"},{value:"gte",label:"Greater or Equal"},{value:"lte",label:"Less or Equal"},{value:"contains",label:"Contains"},{value:"is_empty",label:"Is Empty"},{value:"is_not_empty",label:"Is Not Empty"}];function z({node:a,level:d,entities:h,onRefresh:i,isFirstSibling:j=!1}){let[k,l]=(0,c.useState)([]),[o,r]=(0,c.useState)(!0),[v,w]=(0,c.useState)([]),{toast:x}=(0,m.useToast)();(0,c.useEffect)(()=>{a.is_group?A():a.entity_id&&B(a.entity_id)},[a.id,a.is_group,a.entity_id]);let A=async()=>{let{data:b}=await e.supabase.from("query_conditions").select("*").eq("parent_condition_id",a.id).order("position");l(b||[])},B=async a=>{let{data:b}=await e.supabase.from("entity_fields").select("id, name, display_name, entity_id").eq("entity_id",a).order("display_name");w(b||[])},C=async b=>{try{let{error:c}=await e.supabase.from("query_conditions").update(b).eq("id",a.id);if(c)throw c;b.entity_id&&B(b.entity_id),i(),a.is_group&&A()}catch(a){x({title:"Error updating condition",description:a.message,variant:"destructive"})}},D=async()=>{try{let{error:b}=await e.supabase.from("query_conditions").delete().eq("id",a.id);if(b)throw b;i(),x({title:"Condition deleted"})}catch(a){x({title:"Error deleting condition",description:a.message,variant:"destructive"})}},E=async()=>{if(!h.length)return void x({title:"No entities available",description:"Please create at least one entity first.",variant:"destructive"});try{let b=k.length,{error:c}=await e.supabase.from("query_conditions").insert({query_id:a.query_id,parent_condition_id:a.id,is_group:!1,entity_id:h[0].id,field_name:"",operator:"equals",value:"",position:b});if(c)throw c;A(),x({title:"Condition added"})}catch(a){x({title:"Error adding condition",description:a.message,variant:"destructive"})}},F=async()=>{try{let b=k.length,{error:c}=await e.supabase.from("query_conditions").insert({query_id:a.query_id,parent_condition_id:a.id,is_group:!0,logic:"and",position:b});if(c)throw c;A(),x({title:"Condition group added"})}catch(a){x({title:"Error adding condition group",description:a.message,variant:"destructive"})}};return a.is_group?(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsxs)("div",{className:"flex items-center gap-1.5 p-2 rounded-md bg-muted/30 hover:bg-muted/50 transition-colors",children:[(0,b.jsx)(f.Button,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0",onClick:()=>r(!o),children:o?(0,b.jsx)(u.ChevronDown,{className:"h-3 w-3"}):(0,b.jsx)(t.ChevronRight,{className:"h-3 w-3"})}),(0,b.jsxs)(n.Select,{value:a.logic||"and",onValueChange:a=>C({logic:a}),children:[(0,b.jsx)(n.SelectTrigger,{className:"h-6 w-16 text-xs",children:(0,b.jsx)(n.SelectValue,{})}),(0,b.jsxs)(n.SelectContent,{className:"bg-popover z-50",children:[(0,b.jsx)(n.SelectItem,{value:"and",className:"text-xs",children:"AND"}),(0,b.jsx)(n.SelectItem,{value:"or",className:"text-xs",children:"OR"})]})]}),(0,b.jsx)(s,{className:"h-3.5 w-3.5 text-muted-foreground"}),(0,b.jsx)("span",{className:"text-xs font-medium",children:"Condition Group"}),(0,b.jsx)("div",{className:"flex-1"}),(0,b.jsxs)(f.Button,{onClick:E,size:"sm",variant:"ghost",className:"h-6 text-xs px-1.5",children:[(0,b.jsx)(p.Plus,{className:"h-3 w-3 mr-1"}),"Condition"]}),(0,b.jsxs)(f.Button,{onClick:F,size:"sm",variant:"ghost",className:"h-6 text-xs px-1.5",children:[(0,b.jsx)(s,{className:"h-3 w-3 mr-1"}),"Group"]}),(0,b.jsx)(f.Button,{variant:"ghost",size:"sm",onClick:D,className:"h-6 w-6 p-0",children:(0,b.jsx)(q.Trash2,{className:"h-3 w-3 text-destructive"})})]}),o&&(0,b.jsx)("div",{className:"ml-3 border-l-2 border-border/50 pl-2 space-y-1",children:0===k.length?(0,b.jsx)("div",{className:"bg-muted/20 p-2 rounded text-center",children:(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:"Empty group"})}):k.map((a,c)=>(0,b.jsx)(z,{node:a,level:d+1,entities:h,onRefresh:A,isFirstSibling:0===c},a.id))})]}):(0,b.jsxs)("div",{className:"flex items-center gap-1.5 p-2 rounded-md bg-card border hover:border-primary/30 transition-colors group",children:[j?(0,b.jsx)("div",{className:"h-6 w-14 flex items-center justify-center",children:(0,b.jsx)("span",{className:"text-[10px] text-muted-foreground font-medium",children:"AND"})}):(0,b.jsxs)(n.Select,{value:a.logic||"and",onValueChange:a=>C({logic:a}),children:[(0,b.jsx)(n.SelectTrigger,{className:"h-6 w-14 text-xs",children:(0,b.jsx)(n.SelectValue,{})}),(0,b.jsxs)(n.SelectContent,{className:"bg-popover z-50",children:[(0,b.jsx)(n.SelectItem,{value:"and",className:"text-xs",children:"AND"}),(0,b.jsx)(n.SelectItem,{value:"or",className:"text-xs",children:"OR"})]})]}),(0,b.jsxs)(n.Select,{value:a.entity_id||"",onValueChange:a=>C({entity_id:a}),children:[(0,b.jsx)(n.SelectTrigger,{className:"h-7 w-[110px] text-xs",children:(0,b.jsx)(n.SelectValue,{placeholder:"Entity"})}),(0,b.jsx)(n.SelectContent,{className:"bg-popover z-50",children:h.map(a=>(0,b.jsx)(n.SelectItem,{value:a.id,className:"text-xs",children:a.display_name},a.id))})]}),(0,b.jsxs)(n.Select,{value:a.field_name||"",onValueChange:a=>C({field_name:a}),children:[(0,b.jsx)(n.SelectTrigger,{className:"h-7 w-[110px] text-xs",children:(0,b.jsx)(n.SelectValue,{placeholder:"Field"})}),(0,b.jsx)(n.SelectContent,{className:"bg-popover z-50",children:v.map(a=>(0,b.jsx)(n.SelectItem,{value:a.name,className:"text-xs",children:a.display_name},a.id))})]}),(0,b.jsxs)(n.Select,{value:a.operator||"equals",onValueChange:a=>C({operator:a}),children:[(0,b.jsx)(n.SelectTrigger,{className:"h-7 w-[100px] text-xs",children:(0,b.jsx)(n.SelectValue,{})}),(0,b.jsx)(n.SelectContent,{className:"bg-popover z-50",children:y.map(a=>(0,b.jsx)(n.SelectItem,{value:a.value,className:"text-xs",children:a.label},a.value))})]}),(0,b.jsx)(g.Input,{placeholder:"Value",value:a.value||"",onChange:a=>C({value:a.target.value}),className:"h-7 w-[110px] text-xs"}),(0,b.jsx)(f.Button,{variant:"ghost",size:"sm",onClick:D,className:"h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity",children:(0,b.jsx)(q.Trash2,{className:"h-3 w-3 text-destructive"})})]})}let A=function({queryId:a}){let[d,g]=(0,c.useState)([]),[h,i]=(0,c.useState)([]),{toast:j}=(0,m.useToast)();(0,c.useEffect)(()=>{k(),l()},[a]);let k=async()=>{let{data:a}=await e.supabase.from("entities").select("id, display_name").order("display_name");g(a||[])},l=async()=>{let{data:b}=await e.supabase.from("query_conditions").select("*").eq("query_id",a).is("parent_condition_id",null).order("position");i(b||[])},n=async(b=null)=>{if(console.log("addCondition called",{parentId:b,entitiesLength:d.length}),!d.length)return void j({title:"No entities available",description:"Please create at least one entity first.",variant:"destructive"});try{let c=h.length,f={query_id:a,parent_condition_id:b,is_group:!1,entity_id:d[0].id,field_name:"",operator:"equals",value:"",position:c};console.log("Inserting condition:",f);let{data:g,error:i}=await e.supabase.from("query_conditions").insert(f);if(console.log("Insert result:",{data:g,error:i}),i)throw i;l(),j({title:"Condition added"})}catch(a){console.error("Error adding condition:",a),j({title:"Error adding condition",description:a.message,variant:"destructive"})}},o=async(b=null)=>{console.log("addConditionGroup called",{parentId:b});try{let c=h.length,d={query_id:a,parent_condition_id:b,is_group:!0,logic:"and",position:c};console.log("Inserting condition group:",d);let{data:f,error:g}=await e.supabase.from("query_conditions").insert(d);if(console.log("Insert group result:",{data:f,error:g}),g)throw g;l(),j({title:"Condition group added"})}catch(a){console.error("Error adding condition group:",a),j({title:"Error adding condition group",description:a.message,variant:"destructive"})}};return(0,b.jsxs)("div",{className:"space-y-3",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsx)("h3",{className:"text-sm font-semibold",children:"Conditions"}),(0,b.jsxs)("div",{className:"flex gap-1.5",children:[(0,b.jsxs)(f.Button,{onClick:()=>n(),size:"sm",variant:"outline",className:"h-7 text-xs",children:[(0,b.jsx)(p.Plus,{className:"h-3 w-3 mr-1"}),"Condition"]}),(0,b.jsxs)(f.Button,{onClick:()=>o(),size:"sm",variant:"outline",className:"h-7 text-xs",children:[(0,b.jsx)(s,{className:"h-3 w-3 mr-1"}),"Group"]})]})]}),0===h.length?(0,b.jsx)("div",{className:"bg-muted/30 p-4 rounded-md text-center",children:(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:'No conditions configured. Click "Condition" to add one.'})}):(0,b.jsx)("div",{className:"space-y-1 border-l-2 border-border/50 pl-2",children:h.map((a,c)=>(0,b.jsx)(z,{node:a,level:0,entities:d,onRefresh:l,isFirstSibling:0===c},a.id))})]})};function B(){let a=(0,d.useParams)().queryId,n=(0,d.useRouter)(),{toast:p}=(0,m.useToast)(),[q,s]=(0,c.useState)(!0),[t,u]=(0,c.useState)(!1),[v,w]=(0,c.useState)(null),[y,z]=(0,c.useState)(null);(0,c.useEffect)(()=>{B()},[a]);let B=async()=>{try{let{data:b,error:c}=await e.supabase.from("queries").select("*").eq("id",a).single();if(c)throw c;w(b);let{data:d}=await e.supabase.from("query_settings").select("*").eq("query_id",a).maybeSingle();z(d)}catch(a){p({title:"Error loading query",description:a.message,variant:"destructive"}),n.push("/admin/queries")}finally{s(!1)}},C=async()=>{u(!0);try{let{error:b}=await e.supabase.from("queries").update({display_name:v.display_name,description:v.description,is_published:v.is_published}).eq("id",a);if(b)throw b;p({title:"Query saved",description:"Your changes have been saved successfully."})}catch(a){p({title:"Error saving query",description:a.message,variant:"destructive"})}finally{u(!1)}};return q?(0,b.jsx)("div",{className:"min-h-screen bg-background flex items-center justify-center",children:(0,b.jsx)("p",{className:"text-muted-foreground",children:"Loading query..."})}):v?(0,b.jsxs)("div",{className:"min-h-screen bg-background",children:[(0,b.jsx)("div",{className:"border-b",children:(0,b.jsxs)("div",{className:"max-w-7xl mx-auto px-8 py-4 flex justify-between items-center",children:[(0,b.jsxs)("div",{className:"flex items-center gap-4",children:[(0,b.jsx)(f.Button,{variant:"ghost",size:"icon",onClick:()=>n.push("/admin/queries"),children:(0,b.jsx)(k.ArrowLeft,{className:"h-4 w-4"})}),(0,b.jsxs)("div",{children:[(0,b.jsx)("h1",{className:"text-2xl font-bold",children:v.display_name}),(0,b.jsxs)("p",{className:"text-sm text-muted-foreground",children:[v.query_type," query"]})]})]}),(0,b.jsxs)(f.Button,{onClick:C,disabled:t,children:[(0,b.jsx)(l.Save,{className:"mr-2 h-4 w-4"}),t?"Saving...":"Save Changes"]})]})}),(0,b.jsx)("div",{className:"max-w-7xl mx-auto px-8 py-8",children:(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(h.Label,{htmlFor:"displayName",children:"Display Name"}),(0,b.jsx)(g.Input,{id:"displayName",value:v.display_name,onChange:a=>w({...v,display_name:a.target.value})})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(h.Label,{htmlFor:"description",children:"Description"}),(0,b.jsx)(i.Textarea,{id:"description",value:v.description||"",onChange:a=>w({...v,description:a.target.value}),rows:3})]}),(0,b.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,b.jsx)(j.Switch,{id:"published",checked:v.is_published,onCheckedChange:a=>w({...v,is_published:a})}),(0,b.jsx)(h.Label,{htmlFor:"published",children:"Published"})]}),y?.primary_entity_id&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(o,{queryId:a,queryType:v.query_type}),(0,b.jsx)(r,{queryId:a,queryType:v.query_type,primaryEntityId:y.primary_entity_id}),(0,b.jsx)(x,{queryId:a}),(0,b.jsx)(A,{queryId:a})]}),!y?.primary_entity_id&&(0,b.jsxs)("div",{className:"bg-muted/50 p-6 rounded-lg",children:[(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:"Configure query settings below to start building your query. Set the primary entity first."}),(0,b.jsx)("div",{className:"mt-4",children:(0,b.jsx)(o,{queryId:a,queryType:v.query_type})})]})]})})]}):null}a.s(["default",()=>B],2539)}];

//# sourceMappingURL=src_views_QueryEditor_tsx_8156b917._.js.map
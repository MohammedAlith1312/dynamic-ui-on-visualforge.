(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,10999,e=>{"use strict";var t=e.i(43476),s=e.i(71645),i=e.i(18566),a=e.i(41867),r=e.i(19455),l=e.i(93479),n=e.i(10204),d=e.i(24687),o=e.i(99375),c=e.i(71689),u=e.i(56909),m=e.i(74911),h=e.i(67489);function x({queryId:e,queryType:i}){let{toast:r}=(0,m.useToast)(),[d,c]=(0,s.useState)([]),[u,x]=(0,s.useState)({primary_entity_id:"",group_by:[],sort_entity_id:null,sort_field:null,sort_order:"asc",limit_rows:50,display_style:"table",show_row_numbers:!1});(0,s.useEffect)(()=>{p(),g()},[e]);let p=async()=>{let{data:e}=await a.supabase.from("entities").select("id, display_name").order("display_name");c(e||[])},g=async()=>{let{data:t}=await a.supabase.from("query_settings").select("*").eq("query_id",e).maybeSingle();t&&x(t)},y=async t=>{let s={...u,...t};x(s);try{let{error:t}=await a.supabase.from("query_settings").upsert({query_id:e,...s});if(t)throw t}catch(e){r({title:"Error updating settings",description:e.message,variant:"destructive"})}};return(0,t.jsxs)("div",{className:"space-y-6 p-6 border rounded-lg",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold",children:"Query Settings"}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(n.Label,{children:"Primary Entity"}),(0,t.jsxs)(h.Select,{value:u.primary_entity_id,onValueChange:e=>y({primary_entity_id:e}),children:[(0,t.jsx)(h.SelectTrigger,{children:(0,t.jsx)(h.SelectValue,{placeholder:"Select entity"})}),(0,t.jsx)(h.SelectContent,{children:d.map(e=>(0,t.jsx)(h.SelectItem,{value:e.id,children:e.display_name},e.id))})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(n.Label,{children:"Sort Field"}),(0,t.jsx)(l.Input,{placeholder:"Field name",value:u.sort_field||"",onChange:e=>y({sort_field:e.target.value})})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(n.Label,{children:"Sort Order"}),(0,t.jsxs)(h.Select,{value:u.sort_order||"asc",onValueChange:e=>y({sort_order:e}),children:[(0,t.jsx)(h.SelectTrigger,{children:(0,t.jsx)(h.SelectValue,{})}),(0,t.jsxs)(h.SelectContent,{children:[(0,t.jsx)(h.SelectItem,{value:"asc",children:"Ascending"}),(0,t.jsx)(h.SelectItem,{value:"desc",children:"Descending"})]})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(n.Label,{children:"Limit Rows"}),(0,t.jsx)(l.Input,{type:"number",min:"1",max:"500",value:u.limit_rows,onChange:e=>y({limit_rows:parseInt(e.target.value)||50})})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(n.Label,{children:"Display Style"}),(0,t.jsxs)(h.Select,{value:u.display_style,onValueChange:e=>y({display_style:e}),children:[(0,t.jsx)(h.SelectTrigger,{children:(0,t.jsx)(h.SelectValue,{})}),(0,t.jsxs)(h.SelectContent,{children:[(0,t.jsx)(h.SelectItem,{value:"table",children:"Table"}),(0,t.jsx)(h.SelectItem,{value:"grid",children:"Grid"}),(0,t.jsx)(h.SelectItem,{value:"list",children:"List"})]})]})]}),(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(o.Switch,{checked:u.show_row_numbers,onCheckedChange:e=>y({show_row_numbers:e})}),(0,t.jsx)(n.Label,{children:"Show Row Numbers"})]})]})}var p=e.i(7233),g=e.i(27612);function y({queryId:e,queryType:i,primaryEntityId:l}){let{toast:d}=(0,m.useToast)(),[o,c]=(0,s.useState)([]),[u,x]=(0,s.useState)([]),[y,j]=(0,s.useState)(""),[v,_]=(0,s.useState)(""),[f,N]=(0,s.useState)(""),[b,S]=(0,s.useState)([]);(0,s.useEffect)(()=>{w(),q()},[e]);let w=async()=>{let{data:e}=await a.supabase.from("entities").select("id, display_name").order("display_name");c(e||[])},q=async()=>{let{data:t}=await a.supabase.from("query_fields").select("*").eq("query_id",e).order("position");x(t||[])},C=async e=>{if(!e)return void S([]);let{data:t}=await a.supabase.from("entity_fields").select("id, name, display_name, field_type").eq("entity_id",e).order("position");S(t||[])},I=async()=>{if(y&&v)try{let{error:t}=await a.supabase.from("query_fields").insert({query_id:e,entity_id:y,field_name:v,aggregation:"aggregate"===i&&f||null,position:u.length});if(t)throw t;j(""),_(""),N(""),q(),d({title:"Field added",description:"The field has been added to the query."})}catch(e){d({title:"Error adding field",description:e.message,variant:"destructive"})}},E=async e=>{try{let{error:t}=await a.supabase.from("query_fields").delete().eq("id",e);if(t)throw t;q(),d({title:"Field removed",description:"The field has been removed from the query."})}catch(e){d({title:"Error removing field",description:e.message,variant:"destructive"})}};return(0,t.jsxs)("div",{className:"space-y-4 p-6 border rounded-lg",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold",children:"Query Fields"}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(n.Label,{children:"Entity"}),(0,t.jsxs)(h.Select,{value:y,onValueChange:e=>{j(e),_(""),S([]),C(e)},children:[(0,t.jsx)(h.SelectTrigger,{children:(0,t.jsx)(h.SelectValue,{placeholder:"Select entity"})}),(0,t.jsx)(h.SelectContent,{children:o.map(e=>(0,t.jsx)(h.SelectItem,{value:e.id,children:e.display_name},e.id))})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(n.Label,{children:"Field"}),(0,t.jsxs)(h.Select,{value:v,onValueChange:_,disabled:!y||0===b.length,children:[(0,t.jsx)(h.SelectTrigger,{children:(0,t.jsx)(h.SelectValue,{placeholder:y?"Select field":"Select entity first"})}),(0,t.jsx)(h.SelectContent,{children:b.map(e=>(0,t.jsxs)(h.SelectItem,{value:e.name,children:[e.display_name," (",e.field_type,")"]},e.id))})]})]}),"aggregate"===i&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(n.Label,{children:"Aggregation"}),(0,t.jsxs)(h.Select,{value:f,onValueChange:N,children:[(0,t.jsx)(h.SelectTrigger,{children:(0,t.jsx)(h.SelectValue,{placeholder:"None"})}),(0,t.jsxs)(h.SelectContent,{children:[(0,t.jsx)(h.SelectItem,{value:"",children:"None"}),(0,t.jsx)(h.SelectItem,{value:"count",children:"COUNT"}),(0,t.jsx)(h.SelectItem,{value:"sum",children:"SUM"}),(0,t.jsx)(h.SelectItem,{value:"avg",children:"AVG"}),(0,t.jsx)(h.SelectItem,{value:"min",children:"MIN"}),(0,t.jsx)(h.SelectItem,{value:"max",children:"MAX"})]})]})]})]}),(0,t.jsxs)(r.Button,{onClick:I,size:"sm",children:[(0,t.jsx)(p.Plus,{className:"h-4 w-4 mr-2"}),"Add Field"]}),(0,t.jsx)("div",{className:"space-y-2 mt-4",children:u.map(e=>{let s=o.find(t=>t.id===e.entity_id);return(0,t.jsxs)("div",{className:"flex items-center justify-between p-2 border rounded",children:[(0,t.jsxs)("span",{className:"text-sm",children:[s?.display_name,": ",e.field_name,e.aggregation&&` (${e.aggregation.toUpperCase()})`]}),(0,t.jsx)(r.Button,{variant:"ghost",size:"sm",onClick:()=>E(e.id),children:(0,t.jsx)(g.Trash2,{className:"h-4 w-4"})})]},e.id)})})]})}let j=(0,e.i(75254).default)("FolderPlus",[["path",{d:"M12 10v6",key:"1bos4e"}],["path",{d:"M9 13h6",key:"1uhe8q"}],["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]]);var v=e.i(63059),_=e.i(64659);let f=[{value:"inner",label:"Inner Join"},{value:"left",label:"Left Join"},{value:"right",label:"Right Join"}];function N({node:e,level:i,entities:l,onRefresh:n}){let[d,o]=(0,s.useState)([]),[c,u]=(0,s.useState)(!0),[x,y]=(0,s.useState)([]),[b,S]=(0,s.useState)([]),[w,q]=(0,s.useState)([]),{toast:C}=(0,m.useToast)();(0,s.useEffect)(()=>{e.is_group?I():e.target_entity_id&&(E(e.target_entity_id),T())},[e.id,e.is_group,e.target_entity_id]);let I=async()=>{let{data:t}=await a.supabase.from("query_joins").select("*").eq("parent_join_id",e.id).order("position");o(t||[])},E=async e=>{let{data:t}=await a.supabase.from("entity_fields").select("id, name, display_name, entity_id").eq("entity_id",e).order("display_name");S(t||[])},T=async()=>{let{data:t}=await a.supabase.from("query_join_conditions").select("*").eq("join_id",e.id).order("position");q(t||[])},V=async t=>{try{let{error:s}=await a.supabase.from("query_joins").update(t).eq("id",e.id);if(s)throw s;t.target_entity_id&&E(t.target_entity_id),n(),e.is_group&&I()}catch(e){C({title:"Error updating join",description:e.message,variant:"destructive"})}},k=async()=>{try{let{error:t}=await a.supabase.from("query_joins").delete().eq("id",e.id);if(t)throw t;n(),C({title:"Join deleted"})}catch(e){C({title:"Error deleting join",description:e.message,variant:"destructive"})}},z=async()=>{if(!l.length)return void C({title:"No entities available",description:"Please create at least one entity first.",variant:"destructive"});try{let t=d.length,{error:s}=await a.supabase.from("query_joins").insert({query_id:e.query_id,parent_join_id:e.id,is_group:!1,target_entity_id:l[0].id,join_type:"inner",primary_field:"",target_field:"",position:t});if(s)throw s;I(),C({title:"Join added"})}catch(e){C({title:"Error adding join",description:e.message,variant:"destructive"})}},B=async()=>{try{let t=d.length,{error:s}=await a.supabase.from("query_joins").insert({query_id:e.query_id,parent_join_id:e.id,is_group:!0,position:t});if(s)throw s;I(),C({title:"Join group added"})}catch(e){C({title:"Error adding join group",description:e.message,variant:"destructive"})}},L=async()=>{if(!b.length)return void C({title:"No fields available",description:"Select an entity first.",variant:"destructive"});try{let t=w.length,{error:s}=await a.supabase.from("query_join_conditions").insert({join_id:e.id,primary_field:b[0].name,target_field:b[0].name,logic:"and",position:t});if(s)throw s;T(),C({title:"Join condition added"})}catch(e){C({title:"Error adding join condition",description:e.message,variant:"destructive"})}},J=async(e,t)=>{try{let{error:s}=await a.supabase.from("query_join_conditions").update(t).eq("id",e);if(s)throw s;T()}catch(e){C({title:"Error updating join condition",description:e.message,variant:"destructive"})}},P=async e=>{try{let{error:t}=await a.supabase.from("query_join_conditions").delete().eq("id",e);if(t)throw t;T(),C({title:"Join condition deleted"})}catch(e){C({title:"Error deleting join condition",description:e.message,variant:"destructive"})}};return e.is_group?(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsxs)("div",{className:"flex items-center gap-1.5 p-2 rounded-md bg-muted/30 hover:bg-muted/50 transition-colors",children:[(0,t.jsx)(r.Button,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0",onClick:()=>u(!c),children:c?(0,t.jsx)(_.ChevronDown,{className:"h-3 w-3"}):(0,t.jsx)(v.ChevronRight,{className:"h-3 w-3"})}),(0,t.jsx)(j,{className:"h-3.5 w-3.5 text-muted-foreground"}),(0,t.jsx)("span",{className:"text-xs font-medium",children:"Join Group"}),(0,t.jsx)("div",{className:"flex-1"}),(0,t.jsxs)(r.Button,{onClick:z,size:"sm",variant:"ghost",className:"h-6 text-xs px-1.5",children:[(0,t.jsx)(p.Plus,{className:"h-3 w-3 mr-1"}),"Join"]}),(0,t.jsxs)(r.Button,{onClick:B,size:"sm",variant:"ghost",className:"h-6 text-xs px-1.5",children:[(0,t.jsx)(j,{className:"h-3 w-3 mr-1"}),"Group"]}),(0,t.jsx)(r.Button,{variant:"ghost",size:"sm",onClick:k,className:"h-6 w-6 p-0",children:(0,t.jsx)(g.Trash2,{className:"h-3 w-3 text-destructive"})})]}),c&&(0,t.jsx)("div",{className:"ml-3 border-l-2 border-border/50 pl-2 space-y-1",children:0===d.length?(0,t.jsx)("div",{className:"bg-muted/20 p-2 rounded text-center",children:(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:"Empty group"})}):d.map(e=>(0,t.jsx)(N,{node:e,level:i+1,entities:l,onRefresh:I},e.id))})]}):(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsxs)("div",{className:"flex items-center gap-1.5 p-2 rounded-md bg-card border hover:border-primary/30 transition-colors group",children:[(0,t.jsxs)(h.Select,{value:e.join_type||"inner",onValueChange:e=>V({join_type:e}),children:[(0,t.jsx)(h.SelectTrigger,{className:"h-7 w-[90px] text-xs",children:(0,t.jsx)(h.SelectValue,{})}),(0,t.jsx)(h.SelectContent,{className:"bg-popover z-50",children:f.map(e=>(0,t.jsx)(h.SelectItem,{value:e.value,className:"text-xs",children:e.label},e.value))})]}),(0,t.jsxs)(h.Select,{value:e.target_entity_id||"",onValueChange:e=>V({target_entity_id:e}),children:[(0,t.jsx)(h.SelectTrigger,{className:"h-7 w-[130px] text-xs",children:(0,t.jsx)(h.SelectValue,{placeholder:"Entity"})}),(0,t.jsx)(h.SelectContent,{className:"bg-popover z-50",children:l.map(e=>(0,t.jsx)(h.SelectItem,{value:e.id,className:"text-xs",children:e.display_name},e.id))})]}),(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:"ON"}),w.length>0&&(0,t.jsxs)("span",{className:"text-xs text-muted-foreground",children:["(",w.length," condition",1!==w.length?"s":"",")"]}),(0,t.jsx)("div",{className:"flex-1"}),(0,t.jsxs)(r.Button,{onClick:L,size:"sm",variant:"ghost",className:"h-6 text-xs px-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[(0,t.jsx)(p.Plus,{className:"h-3 w-3 mr-1"}),"Add Condition"]}),(0,t.jsx)(r.Button,{variant:"ghost",size:"sm",onClick:k,className:"h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity",children:(0,t.jsx)(g.Trash2,{className:"h-3 w-3 text-destructive"})})]}),w.length>0&&(0,t.jsx)("div",{className:"ml-3 border-l-2 border-border/30 pl-2 space-y-1",children:w.map((e,s)=>(0,t.jsxs)("div",{className:"flex items-center gap-1.5 p-1.5 rounded-md bg-muted/20 hover:bg-muted/40 transition-colors group/condition",children:[0===s?(0,t.jsx)("div",{className:"h-6 w-14 flex items-center justify-center",children:(0,t.jsx)("span",{className:"text-[10px] text-muted-foreground font-medium",children:"AND"})}):(0,t.jsxs)(h.Select,{value:e.logic,onValueChange:t=>J(e.id,{logic:t}),children:[(0,t.jsx)(h.SelectTrigger,{className:"h-6 w-14 text-xs",children:(0,t.jsx)(h.SelectValue,{})}),(0,t.jsxs)(h.SelectContent,{className:"bg-popover z-50",children:[(0,t.jsx)(h.SelectItem,{value:"and",className:"text-xs",children:"AND"}),(0,t.jsx)(h.SelectItem,{value:"or",className:"text-xs",children:"OR"})]})]}),(0,t.jsxs)(h.Select,{value:e.primary_field,onValueChange:t=>J(e.id,{primary_field:t}),children:[(0,t.jsx)(h.SelectTrigger,{className:"h-6 w-[110px] text-xs",children:(0,t.jsx)(h.SelectValue,{placeholder:"Primary field"})}),(0,t.jsx)(h.SelectContent,{className:"bg-popover z-50",children:b.map(e=>(0,t.jsx)(h.SelectItem,{value:e.name,className:"text-xs",children:e.display_name},e.id))})]}),(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:"="}),(0,t.jsxs)(h.Select,{value:e.target_field,onValueChange:t=>J(e.id,{target_field:t}),children:[(0,t.jsx)(h.SelectTrigger,{className:"h-6 w-[110px] text-xs",children:(0,t.jsx)(h.SelectValue,{placeholder:"Target field"})}),(0,t.jsx)(h.SelectContent,{className:"bg-popover z-50",children:b.map(e=>(0,t.jsx)(h.SelectItem,{value:e.name,className:"text-xs",children:e.display_name},e.id))})]}),(0,t.jsx)(r.Button,{variant:"ghost",size:"sm",onClick:()=>P(e.id),className:"h-5 w-5 p-0 opacity-0 group-hover/condition:opacity-100 transition-opacity",children:(0,t.jsx)(g.Trash2,{className:"h-2.5 w-2.5 text-destructive"})})]},e.id))})]})}let b=function({queryId:e}){let[i,l]=(0,s.useState)([]),[n,d]=(0,s.useState)([]),{toast:o}=(0,m.useToast)();(0,s.useEffect)(()=>{c(),u()},[e]);let c=async()=>{let{data:e}=await a.supabase.from("entities").select("id, display_name").order("display_name");l(e||[])},u=async()=>{let{data:t}=await a.supabase.from("query_joins").select("*").eq("query_id",e).is("parent_join_id",null).order("position");d(t||[])},h=async(t=null)=>{if(console.log("addJoin called",{parentId:t,entitiesLength:i.length}),!i.length)return void o({title:"No entities available",description:"Please create at least one entity first.",variant:"destructive"});try{let s=n.length,r={query_id:e,parent_join_id:t,is_group:!1,target_entity_id:i[0].id,join_type:"inner",primary_field:"",target_field:"",position:s};console.log("Inserting join:",r);let{data:l,error:d}=await a.supabase.from("query_joins").insert(r);if(console.log("Insert result:",{data:l,error:d}),d)throw d;u(),o({title:"Join added"})}catch(e){console.error("Error adding join:",e),o({title:"Error adding join",description:e.message,variant:"destructive"})}},x=async(t=null)=>{console.log("addJoinGroup called",{parentId:t});try{let s=n.length,i={query_id:e,parent_join_id:t,is_group:!0,position:s};console.log("Inserting join group:",i);let{data:r,error:l}=await a.supabase.from("query_joins").insert(i);if(console.log("Insert group result:",{data:r,error:l}),l)throw l;u(),o({title:"Join group added"})}catch(e){console.error("Error adding join group:",e),o({title:"Error adding join group",description:e.message,variant:"destructive"})}};return(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("h3",{className:"text-sm font-semibold",children:"Joins"}),(0,t.jsxs)("div",{className:"flex gap-1.5",children:[(0,t.jsxs)(r.Button,{onClick:()=>h(),size:"sm",variant:"outline",className:"h-7 text-xs",children:[(0,t.jsx)(p.Plus,{className:"h-3 w-3 mr-1"}),"Join"]}),(0,t.jsxs)(r.Button,{onClick:()=>x(),size:"sm",variant:"outline",className:"h-7 text-xs",children:[(0,t.jsx)(j,{className:"h-3 w-3 mr-1"}),"Group"]})]})]}),0===n.length?(0,t.jsx)("div",{className:"bg-muted/30 p-4 rounded-md text-center",children:(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:'No joins configured. Click "Join" to add one.'})}):(0,t.jsx)("div",{className:"space-y-1 border-l-2 border-border/50 pl-2",children:n.map(e=>(0,t.jsx)(N,{node:e,level:0,entities:i,onRefresh:u},e.id))})]})},S=[{value:"equals",label:"Equals"},{value:"not_equals",label:"Not Equals"},{value:"gt",label:"Greater Than"},{value:"lt",label:"Less Than"},{value:"gte",label:"Greater or Equal"},{value:"lte",label:"Less or Equal"},{value:"contains",label:"Contains"},{value:"is_empty",label:"Is Empty"},{value:"is_not_empty",label:"Is Not Empty"}];function w({node:e,level:i,entities:n,onRefresh:d,isFirstSibling:o=!1}){let[c,u]=(0,s.useState)([]),[x,y]=(0,s.useState)(!0),[f,N]=(0,s.useState)([]),{toast:b}=(0,m.useToast)();(0,s.useEffect)(()=>{e.is_group?q():e.entity_id&&C(e.entity_id)},[e.id,e.is_group,e.entity_id]);let q=async()=>{let{data:t}=await a.supabase.from("query_conditions").select("*").eq("parent_condition_id",e.id).order("position");u(t||[])},C=async e=>{let{data:t}=await a.supabase.from("entity_fields").select("id, name, display_name, entity_id").eq("entity_id",e).order("display_name");N(t||[])},I=async t=>{try{let{error:s}=await a.supabase.from("query_conditions").update(t).eq("id",e.id);if(s)throw s;t.entity_id&&C(t.entity_id),d(),e.is_group&&q()}catch(e){b({title:"Error updating condition",description:e.message,variant:"destructive"})}},E=async()=>{try{let{error:t}=await a.supabase.from("query_conditions").delete().eq("id",e.id);if(t)throw t;d(),b({title:"Condition deleted"})}catch(e){b({title:"Error deleting condition",description:e.message,variant:"destructive"})}},T=async()=>{if(!n.length)return void b({title:"No entities available",description:"Please create at least one entity first.",variant:"destructive"});try{let t=c.length,{error:s}=await a.supabase.from("query_conditions").insert({query_id:e.query_id,parent_condition_id:e.id,is_group:!1,entity_id:n[0].id,field_name:"",operator:"equals",value:"",position:t});if(s)throw s;q(),b({title:"Condition added"})}catch(e){b({title:"Error adding condition",description:e.message,variant:"destructive"})}},V=async()=>{try{let t=c.length,{error:s}=await a.supabase.from("query_conditions").insert({query_id:e.query_id,parent_condition_id:e.id,is_group:!0,logic:"and",position:t});if(s)throw s;q(),b({title:"Condition group added"})}catch(e){b({title:"Error adding condition group",description:e.message,variant:"destructive"})}};return e.is_group?(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsxs)("div",{className:"flex items-center gap-1.5 p-2 rounded-md bg-muted/30 hover:bg-muted/50 transition-colors",children:[(0,t.jsx)(r.Button,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0",onClick:()=>y(!x),children:x?(0,t.jsx)(_.ChevronDown,{className:"h-3 w-3"}):(0,t.jsx)(v.ChevronRight,{className:"h-3 w-3"})}),(0,t.jsxs)(h.Select,{value:e.logic||"and",onValueChange:e=>I({logic:e}),children:[(0,t.jsx)(h.SelectTrigger,{className:"h-6 w-16 text-xs",children:(0,t.jsx)(h.SelectValue,{})}),(0,t.jsxs)(h.SelectContent,{className:"bg-popover z-50",children:[(0,t.jsx)(h.SelectItem,{value:"and",className:"text-xs",children:"AND"}),(0,t.jsx)(h.SelectItem,{value:"or",className:"text-xs",children:"OR"})]})]}),(0,t.jsx)(j,{className:"h-3.5 w-3.5 text-muted-foreground"}),(0,t.jsx)("span",{className:"text-xs font-medium",children:"Condition Group"}),(0,t.jsx)("div",{className:"flex-1"}),(0,t.jsxs)(r.Button,{onClick:T,size:"sm",variant:"ghost",className:"h-6 text-xs px-1.5",children:[(0,t.jsx)(p.Plus,{className:"h-3 w-3 mr-1"}),"Condition"]}),(0,t.jsxs)(r.Button,{onClick:V,size:"sm",variant:"ghost",className:"h-6 text-xs px-1.5",children:[(0,t.jsx)(j,{className:"h-3 w-3 mr-1"}),"Group"]}),(0,t.jsx)(r.Button,{variant:"ghost",size:"sm",onClick:E,className:"h-6 w-6 p-0",children:(0,t.jsx)(g.Trash2,{className:"h-3 w-3 text-destructive"})})]}),x&&(0,t.jsx)("div",{className:"ml-3 border-l-2 border-border/50 pl-2 space-y-1",children:0===c.length?(0,t.jsx)("div",{className:"bg-muted/20 p-2 rounded text-center",children:(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:"Empty group"})}):c.map((e,s)=>(0,t.jsx)(w,{node:e,level:i+1,entities:n,onRefresh:q,isFirstSibling:0===s},e.id))})]}):(0,t.jsxs)("div",{className:"flex items-center gap-1.5 p-2 rounded-md bg-card border hover:border-primary/30 transition-colors group",children:[o?(0,t.jsx)("div",{className:"h-6 w-14 flex items-center justify-center",children:(0,t.jsx)("span",{className:"text-[10px] text-muted-foreground font-medium",children:"AND"})}):(0,t.jsxs)(h.Select,{value:e.logic||"and",onValueChange:e=>I({logic:e}),children:[(0,t.jsx)(h.SelectTrigger,{className:"h-6 w-14 text-xs",children:(0,t.jsx)(h.SelectValue,{})}),(0,t.jsxs)(h.SelectContent,{className:"bg-popover z-50",children:[(0,t.jsx)(h.SelectItem,{value:"and",className:"text-xs",children:"AND"}),(0,t.jsx)(h.SelectItem,{value:"or",className:"text-xs",children:"OR"})]})]}),(0,t.jsxs)(h.Select,{value:e.entity_id||"",onValueChange:e=>I({entity_id:e}),children:[(0,t.jsx)(h.SelectTrigger,{className:"h-7 w-[110px] text-xs",children:(0,t.jsx)(h.SelectValue,{placeholder:"Entity"})}),(0,t.jsx)(h.SelectContent,{className:"bg-popover z-50",children:n.map(e=>(0,t.jsx)(h.SelectItem,{value:e.id,className:"text-xs",children:e.display_name},e.id))})]}),(0,t.jsxs)(h.Select,{value:e.field_name||"",onValueChange:e=>I({field_name:e}),children:[(0,t.jsx)(h.SelectTrigger,{className:"h-7 w-[110px] text-xs",children:(0,t.jsx)(h.SelectValue,{placeholder:"Field"})}),(0,t.jsx)(h.SelectContent,{className:"bg-popover z-50",children:f.map(e=>(0,t.jsx)(h.SelectItem,{value:e.name,className:"text-xs",children:e.display_name},e.id))})]}),(0,t.jsxs)(h.Select,{value:e.operator||"equals",onValueChange:e=>I({operator:e}),children:[(0,t.jsx)(h.SelectTrigger,{className:"h-7 w-[100px] text-xs",children:(0,t.jsx)(h.SelectValue,{})}),(0,t.jsx)(h.SelectContent,{className:"bg-popover z-50",children:S.map(e=>(0,t.jsx)(h.SelectItem,{value:e.value,className:"text-xs",children:e.label},e.value))})]}),(0,t.jsx)(l.Input,{placeholder:"Value",value:e.value||"",onChange:e=>I({value:e.target.value}),className:"h-7 w-[110px] text-xs"}),(0,t.jsx)(r.Button,{variant:"ghost",size:"sm",onClick:E,className:"h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity",children:(0,t.jsx)(g.Trash2,{className:"h-3 w-3 text-destructive"})})]})}let q=function({queryId:e}){let[i,l]=(0,s.useState)([]),[n,d]=(0,s.useState)([]),{toast:o}=(0,m.useToast)();(0,s.useEffect)(()=>{c(),u()},[e]);let c=async()=>{let{data:e}=await a.supabase.from("entities").select("id, display_name").order("display_name");l(e||[])},u=async()=>{let{data:t}=await a.supabase.from("query_conditions").select("*").eq("query_id",e).is("parent_condition_id",null).order("position");d(t||[])},h=async(t=null)=>{if(console.log("addCondition called",{parentId:t,entitiesLength:i.length}),!i.length)return void o({title:"No entities available",description:"Please create at least one entity first.",variant:"destructive"});try{let s=n.length,r={query_id:e,parent_condition_id:t,is_group:!1,entity_id:i[0].id,field_name:"",operator:"equals",value:"",position:s};console.log("Inserting condition:",r);let{data:l,error:d}=await a.supabase.from("query_conditions").insert(r);if(console.log("Insert result:",{data:l,error:d}),d)throw d;u(),o({title:"Condition added"})}catch(e){console.error("Error adding condition:",e),o({title:"Error adding condition",description:e.message,variant:"destructive"})}},x=async(t=null)=>{console.log("addConditionGroup called",{parentId:t});try{let s=n.length,i={query_id:e,parent_condition_id:t,is_group:!0,logic:"and",position:s};console.log("Inserting condition group:",i);let{data:r,error:l}=await a.supabase.from("query_conditions").insert(i);if(console.log("Insert group result:",{data:r,error:l}),l)throw l;u(),o({title:"Condition group added"})}catch(e){console.error("Error adding condition group:",e),o({title:"Error adding condition group",description:e.message,variant:"destructive"})}};return(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("h3",{className:"text-sm font-semibold",children:"Conditions"}),(0,t.jsxs)("div",{className:"flex gap-1.5",children:[(0,t.jsxs)(r.Button,{onClick:()=>h(),size:"sm",variant:"outline",className:"h-7 text-xs",children:[(0,t.jsx)(p.Plus,{className:"h-3 w-3 mr-1"}),"Condition"]}),(0,t.jsxs)(r.Button,{onClick:()=>x(),size:"sm",variant:"outline",className:"h-7 text-xs",children:[(0,t.jsx)(j,{className:"h-3 w-3 mr-1"}),"Group"]})]})]}),0===n.length?(0,t.jsx)("div",{className:"bg-muted/30 p-4 rounded-md text-center",children:(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:'No conditions configured. Click "Condition" to add one.'})}):(0,t.jsx)("div",{className:"space-y-1 border-l-2 border-border/50 pl-2",children:n.map((e,s)=>(0,t.jsx)(w,{node:e,level:0,entities:i,onRefresh:u,isFirstSibling:0===s},e.id))})]})};function C(){let e=(0,i.useParams)().queryId,h=(0,i.useRouter)(),{toast:p}=(0,m.useToast)(),[g,j]=(0,s.useState)(!0),[v,_]=(0,s.useState)(!1),[f,N]=(0,s.useState)(null),[S,w]=(0,s.useState)(null);(0,s.useEffect)(()=>{C()},[e]);let C=async()=>{try{let{data:t,error:s}=await a.supabase.from("queries").select("*").eq("id",e).single();if(s)throw s;N(t);let{data:i}=await a.supabase.from("query_settings").select("*").eq("query_id",e).maybeSingle();w(i)}catch(e){p({title:"Error loading query",description:e.message,variant:"destructive"}),h.push("/admin/queries")}finally{j(!1)}},I=async()=>{_(!0);try{let{error:t}=await a.supabase.from("queries").update({display_name:f.display_name,description:f.description,is_published:f.is_published}).eq("id",e);if(t)throw t;p({title:"Query saved",description:"Your changes have been saved successfully."})}catch(e){p({title:"Error saving query",description:e.message,variant:"destructive"})}finally{_(!1)}};return g?(0,t.jsx)("div",{className:"min-h-screen bg-background flex items-center justify-center",children:(0,t.jsx)("p",{className:"text-muted-foreground",children:"Loading query..."})}):f?(0,t.jsxs)("div",{className:"min-h-screen bg-background",children:[(0,t.jsx)("div",{className:"border-b",children:(0,t.jsxs)("div",{className:"max-w-7xl mx-auto px-8 py-4 flex justify-between items-center",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(r.Button,{variant:"ghost",size:"icon",onClick:()=>h.push("/admin/queries"),children:(0,t.jsx)(c.ArrowLeft,{className:"h-4 w-4"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-2xl font-bold",children:f.display_name}),(0,t.jsxs)("p",{className:"text-sm text-muted-foreground",children:[f.query_type," query"]})]})]}),(0,t.jsxs)(r.Button,{onClick:I,disabled:v,children:[(0,t.jsx)(u.Save,{className:"mr-2 h-4 w-4"}),v?"Saving...":"Save Changes"]})]})}),(0,t.jsx)("div",{className:"max-w-7xl mx-auto px-8 py-8",children:(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(n.Label,{htmlFor:"displayName",children:"Display Name"}),(0,t.jsx)(l.Input,{id:"displayName",value:f.display_name,onChange:e=>N({...f,display_name:e.target.value})})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(n.Label,{htmlFor:"description",children:"Description"}),(0,t.jsx)(d.Textarea,{id:"description",value:f.description||"",onChange:e=>N({...f,description:e.target.value}),rows:3})]}),(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(o.Switch,{id:"published",checked:f.is_published,onCheckedChange:e=>N({...f,is_published:e})}),(0,t.jsx)(n.Label,{htmlFor:"published",children:"Published"})]}),S?.primary_entity_id&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(x,{queryId:e,queryType:f.query_type}),(0,t.jsx)(y,{queryId:e,queryType:f.query_type,primaryEntityId:S.primary_entity_id}),(0,t.jsx)(b,{queryId:e}),(0,t.jsx)(q,{queryId:e})]}),!S?.primary_entity_id&&(0,t.jsxs)("div",{className:"bg-muted/50 p-6 rounded-lg",children:[(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"Configure query settings below to start building your query. Set the primary entity first."}),(0,t.jsx)("div",{className:"mt-4",children:(0,t.jsx)(x,{queryId:e,queryType:f.query_type})})]})]})})]}):null}e.s(["default",()=>C],10999)}]);